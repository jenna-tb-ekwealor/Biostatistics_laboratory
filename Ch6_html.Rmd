---
title: "<center>Biostatistics - BIOL 260"
author: "<center>*Lab 6: Population proportions and the binomial distribution*"
output:
  html_document: default
  pdf_document: default
---

<style type="text/css">
.main-container {
  max-width: 800px;
}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
/* Whole document: */
body{
  font-family: helvetica;
  font-size: 12pt;
}
code {white-space:pre !important; overflow-x:scroll !important;font-size:12pt; font-family:courier;}
</style>


<br><br>
<style>
body {
text-align: justify}
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

**Today's investigation.** A standard rule in nature is that of surviving. As a result, both predator and prey populations are under constant selective pressure; the former evolving adaptations to trap prey and the latter evolving counter-adaptations against predators. This ongoing evolutionary arms race shapes the distribution of prey in space creating Landscapes of Fear. Identifying the factors shaping the landscape of fear of a prey population provides valuable information about the way they see and interpret their environment. One way to study these factors is through the analysis of population proportions using the *binomial test*. Today, we will examine hypotheses about the drivers of landscapes of fear in Amazonian bird flocks using field data from the CSULB Avian Ecology Lab.    
</div>

***

<span style='color:#66023C; font-size:150%; font-weight:600'> Introduction </span>
<br>

In this lab we will examine hypotheses about population proportions using *binomial probabilities* in order to identify important drivers of landscapes of fear in Amazonian bird flocks. The landscape of fear is an ecological concept that defines the level of fear of predation a prey experiences across its home range (Laundré *et al*.; Fig 1). This concept assumes that animals have the ability or can learn to differentiate dangerous habitats from safer ones. For many bird species, the major factor affecting their landscape of fear is their ability to interpret alarm calls. This is significant for eavesdropping birds that use the behavioral cues of other neighbors to mitigate risk without the cost of gathering information by themselves. Interpreting these calls from sentinel birds allows them to distinguish the presence of particular predators with direct consequences on survival and fitness.

Today, we will examine hypotheses about population proportions in order to estimate the probability of sentinel birds to produce an alarm call and distinguish predators. For this, we will use CSULB Avian Ecology Lab data from field experiments lead by Dr. Ari Martínez on Amazonian birds (Fig. 1A, 1B, 1C). In his experiments, Dr. Martínez used trained raptors to examine the extent to which different alarm calling birds produced alarm calls in their presence and evaluated different predator contexts. So, let's explore the binomial distribution and how the *binomial test* is a useful statistical tool for testing whether the relative frequency of alarm calls produced - or *successes* - in the presence of a raptor matches a null expectation or if we can indeed conclude that the presence of a raptor drives the frequency of alarm calls. 

<br>


```{r echo=FALSE,fig.align="left",fig.width=7, fig.asp=.6,fig.cap="**Figure 1. Theoretical landscape of fear and studied Amazonian birds**. The *x*- and *y*-axis represent the physical coordinates of the study area. The predation risk is measured as indices of fear, e.g. vigilance. From this example, we can conclude that the intensity of space used by the prey population (colors) correlates negatively with predation risk. The landscape of fear is studied by the CSULB Avian Ecology Lab using a system of eavesdropping and setinel Amazonian birds: (A) Dusky-throated Antshrike (sentinel), (B) White-eyed Antwren and (C) Carmiol's Tanager (eavesdropping). Images: Ari MArtínez and Juan Pablo Bueno."}
library(png)
library(grid)
img <- readPNG("image2.png")
grid.raster(img)
```
<br>


**Upon completion of this lab, you should be able to:**

  + Estimate binomial probabilities using the binomial formula;
  + Quantify the precision of binomial probability estimates through a standard error;
  + Test hypotheses of population proportions using the binomial test. 

<br>

**External study resources**

  + [Binomial distribution and test](https://www.youtube.com/watch?v=J8jNoF-K8E8)

<br>

**References**

  + [Deconstructing the landscape of fear in stable multi-species societies](https://esajournals.onlinelibrary.wiley.com/doi/pdf/10.1002/ecy.1935?casa_token=h769IbO51G0AAAAA:77iUo9-6N8konMdKMfUGKG05qd8h4JtX6hn5ZJClKafiBxZNdzPI33XKShU_F4QqEtA3Sdg_5tiRMvc)
  
  + [The Landscape of Fear: Ecological Implications of Being Afraid](https://benthamopen.com/contents/pdf/TOECOLJ/TOECOLJ-3-3-1.pdf)

***

<span style='color:#66023C; font-size:150%; font-weight:600'> Worked example </span> 
<br>

To get started, let’s define the binomial distribution and its assumptions:

  + binomial distribution - probability distribution for the number of *successes* in a fixed number of independent trials. Here, the category name "successes" has no (positive) context, rather it represents an occurrence. The binomial distribution and associated tests hold when there is sample independence and equal chance of success among trials as these features minimize bias. 
  
  + Assumptions of the binomial distribution - 
  
    + the number of trials *n* is fixed. 
    + there are only two possible outcomes per trial: successes and failures.
    + trials are independent from each other. 
    + the probability of success *p* is the same in every trial. 


<br>

### 1. The binomial formula
The binomial formula gives the probability of *X* successes in *n* trials, where the outcome of any single trial is either success or failure. Thus, we employ the binomial distribution when we are testing the probability of two outcomes, exclusively, or *two mutually exclusive events*. Recall from Chapter 4 that mutually exclusive events cannot both occur at the same time and their probabilities add to 1.

The probability of getting *X* successes in *n* trials is
<br><br>


<center>
  $\Pr[X\ successes] = \frac{n!}{X!(n-X)!}p^X(1-p)^{n-X}$, 
</center>
<br>

where *X* is the number of successes, *n* is the number of independent trials, and *p* is the probability of success in every single trial. 

Keep in mind that the binomial coefficient $\frac{n!}{X!(n-X)!}$ represents the number of combinations in which we can get *X* successes from *n* trials. Let's say we randomly sample *n* = 4 salamanders from a population. There are 16 possible combinations of successes (represented by 1) and failures (represented by 0) we can obtain with 4 trials:

<br>

<center>
[**1111**; **0111**;  **1011**;  **0011**;  **1101**;  **0101**;  **1001**;  **0001**; **1110**;  **0110**; **1010**; **0010**; **1100**; **0100**; **1000**; **0000**]   
</center>

<br>

If we define success here as body color = red, the number of combinations in which we can get exactly 1 success, or 1 red salamander, out of 4 independent trials is 4 [**0001**; **0010**; **0100**; **1000**]. Thus, the binomial coefficient when *X* = 1 and *n* = 4 is 4 or  $\frac{4!}{1!(4-1)!}$. From the binomial formula above, is obvious that binomial probabilities also depend on *p*, or the probability of success in each trial. Assuming there is 65% chance that an individual salamander is red in any given trial (*p* = 0.65), then we can say that the probability that exactly 1 of the salamanders in our sample population is red is
<br><br>

<center>
$$
\begin{aligned}
 \Pr[1\ red\ salamander]&=\frac{4!}{1!(4-1)!}(0.65)^1(1-0.65)^{4-1}\\\\
 &=0.1115
\end{aligned}
$$
</center>
<br>
  
```{r,eval=FALSE,echo=FALSE}
x <- expand.grid(rep(list(c('1','0')), 3))
x = unique(x)
x$Var1 <- as.numeric(as.character(x$Var1))
x$Var2 <- as.numeric(as.character(x$Var2))
x$Var3 <- as.numeric(as.character(x$Var3))

rowSums(x)
```

### 2. The binomial probability distribution
According to this, there is 11% chance of getting exactly 1 red salamander out of 4 independent trials. If we continue, we can estimate all the probabilities of the sampling distribution with *n* = 4 and *p* = 0.65. For our salamander example, it looks like this:

```{r,echo=FALSE,fig.width=3,fig.height=4,fig.align='center',fig.cap="Figure 2. Probability distribution of successes for sample size *n* = 4 and probability *p* = 0.65.",warning=FALSE}
xsuccesses <- 1:4
probx <- dbinom(xsuccesses, size = 4, prob = .65) 
probTable <- data.frame(xsuccesses, probx)

library(ggplot2)

p1 <- ggplot(probTable,aes(x=xsuccesses,y=probx)) +
  geom_bar(stat = "identity") +
  ylab("Probability") +
  theme_classic(14) +
  xlab("Number of red salamanders")
p1
```

Because the probability of getting a red salamander per trial is relatively high (65%), we can expect to have a low probability (11%) of finding just 1 out of 4 trials!

<br>

### 3. The standard error of a proportion
The precision of our estimates of population proportions can be calculated. Say that we perform the 4 independent trials in our salamander population and get 3 red salamanders. In this case, the actual estimate of the proportion of red salamanders in this sample population is

<br>
<center>
$\hat{p}=\frac{X}{n}$ 
<br><br>
</center>

For our example, 
<center>

<br>

$$
\begin{aligned}
 \hat{p}&=\frac{3}{4}\\\\
 &=0.75
\end{aligned}
$$
</center>


where $\hat{p}$ represents the *sample* proportion, in contrast to the true proportion in the population. We often do not know *p* but we can approximate the standard error using $\hat{p}$ in the following way:

<br>
<center>
$SE_\hat{p}=\sqrt{\frac{\hat{p}(1-\hat{p})}{n}}$
<br><br>
</center>

For our example, 
<center>
$$
\begin{aligned}
 SE_\hat{p}&=\sqrt{\frac{0.75(1-0.75)}{4}}\\\\
 &=0.217
\end{aligned}
$$
</center>
<br>

Thus, the standard error of the estimate of the proportion who are red is 0.217. Remember from Chapter 4 that the SE is a measure of spread (the standard deviation of the sampling distribution). In other words, our sample estimate ($\hat{p}$) on average is 0.217 from the population proportion (*p*). 

<br>

### 4. Testing hypotheses: the binomial test 
We can also use the binomial distribution to test whether the relative frequency of successes in the population (*p*) matches a null expectation $p_{0}$. For this, we follow the same steps to estimate the binomial formula but assuming *p* = $p_{0}$ and testing whether the resulting *p*-value is below the conventional significance level of $\alpha$ = 0.05. 

For example, say we expect color to be equally distributed in salamanders and thus we expect 50% of the salamanders to be red by chance and the other 50% to be *not red*. Following the example above were we found 3 red salamanders out of 4 independent trials, the probability of getting *3 or more* red salamanders assuming the null hypothesis is true is the sum over these mutually exclusive binomial probabilities of having *3 or more* red salamanders in a trial of 4:

<br>

<center>
$$
\begin{aligned}
 Pr[number\ of\ succsesses \ge 3]&=Pr[3]+Pr[4]\\\\
 &=0.380
\end{aligned}
$$
</center>

<br>

Because this is a two-tailed test, we account for all extreme values at both tails by doubling this probability to get the *p*-value:
<center>
$$
\begin{aligned}
 P&=(2)(0.380)\\\\
 &=0.759
\end{aligned}
$$
</center>
<br>

The *p*-value is well above the significance level and thus we do not reject the null hypothesis and conclude that the probability that a salamander is red is 50%.


<br>

<style>
body {
text-align: justify}
div.creme { background-color:#fff5e6; border-radius: 5px; padding: 20px;}
</style>
<div class = "creme">

<span style='color:blue; font-size:120%; font-weight:600'> **Info-Box!** </span>  In Chapter 5, we learned how to document our results in any report or manuscript. Here we add another information; degrees of freedom:

  + test statistics
  + degrees of freedom
  + sample size
  + *p*-value
  
For example, the results from the Worked Example, part 4, could be reported as: The proportion of red salamanders is not different from the proportion of salamanders with other color ($\hat{p}=0.75$, *n* = 4, *df* = 3, *p*-value = 0.76). 
</div>
<br>


***

<span style='color:#66023C; font-size:150%; font-weight:600'> Materials and Methods</span>

+ R and RStudio
+ R packages *ggplot2* and *tidyverse*
+ alarm dataset
  

Today's activity *Avian Alarm Calls in the Tropics* is organized into two main exercises testing different hypotheses about the proportion of sentinel birds making alarm calls in the presence of predators using the binomial distribution and associated tests. These exercises will also motivate inferences about the factors shaping the landscape of fear of Amazonian bird flocks. 

<br><br>

<center>
<span style='color:darkblue; font-size:200%; font-weight:500'>Avian Alarm Calls in the Tropics</span>
</center>
<br>


Is the presence of predators the main driver of alarm calls in Amazonian birds? What particular attributes of that predator are more important cues for the alarm caller? In his experiments, Dr. Ari Martínez and colleagues used trained raptors that flew a certain distance from bird flocks to examine the extent to which different alarm calling birds - sentinels - produced alarm calls in their presence. Their results show that sentinel species indeed vary in the probability of producing alarm calls to aerial predator threats. Let's investigate some of the factors generating these results following each step of the Worked example.

<br>

**1. Research question**: Does the presence of a predator increases the proportion of alarm calls produced by sentinel birds?

Let's start by importing the "alarm" dataset to RStudio and exploring it. **Hint**: review past R scripts and don't forget to use the metadata file for reference.
<br>

**Questions:**

  a. *What type of R object "alarm" is?*
  b. *How many variables and observations "alarm" has?* 
  c. *Considering the research question, what are our variables of interest in "alarm"?*
  d. *Considering our response variable, what represents a success?*

<br>

**A. The binomial formula**. 

Let's first estimate the variables needed for the binomial formula; *X* = number of successes, *n* = number of trials, and *p* = probability of success in a trial. Because the research question does not differentiate between predator attributes, let's analyze the data assuming no difference among predators (raptors in this case). 

First, we need to make sure we differentiate between predator trials and control (no predator) trials by filtering our data.
```{r,eval=FALSE}
# levels in the variable RAPTOR
levels(as.factor(alarm$RAPTOR))

# filtering "alarm" for control trials only 
library(tidyverse)
control <- filter(alarm,RAPTOR=="CONTROL")

# filtering "alarm" for raptor trials only 
raptor <- filter(alarm,RAPTOR!="CONTROL")
```

<br>

Let's estimate the binomial formula using the data in "raptor".
```{r,eval=FALSE}
# number of trials n 
n <- length(raptor$RAPTOR)

# number of successes X (alarms)
X <-sum(raptor$Alarm_Call)

# observed proportion of successes in sample population p_hat
p_hat <- X/n
```

<br>

Now that we have all the variables needed to estimate binomial distributions, let's use the function **dbinom()** to estimate the binomial formula. The first argument in this function is *X*, the second is *n*, and the third is *p_hat*.
```{r,eval=FALSE}
# example: the probability of getting exactly 100 alarm calls with n=337 and p_hat=0.303.
dbinom(100,n,p_hat)
```

According to this, there is about 5% chance that exactly 100 birds out of 337 randomly sampled birds will produce an alarm call in the presence of a raptor.

<br>

**B. The binomial probability distribution**.

We can use this same function **dbinom()** to get *all* the possible binomial probabilities for all values in *n*.

```{r,eval=FALSE}
# all possible values of X out of n trials
X_success <- 1:n
X_success 

# binomial probabilities (same function as above)
prob_X <- dbinom(X_success, n, p_hat)
prob_X
```

<br>

To plot the binomial probability distribution using *ggplot2*, we need to first create a data frame with the probabilities.
```{r,eval=FALSE}
# generating a data frame with X_success and binomial probabilities for the plot
probTable <- data.frame(X_success, prob_X)
probTable

# binomial probability distribution plot
library(ggplot2)

p1 <- ggplot(probTable,aes(x=X_success,y=prob_X)) +
  geom_bar(stat = "identity") +
  ylab("Probability") +
  xlab("Number of alarm calls") +
  theme_classic(20)
p1
```

<br>

**Questions:**

  a. *What is the probability that about 120 sentinel birds out of 337 trials produce an alarm call?*
  b. *What is the number of alarm calls with the highest probability?*

<br>

**C. The standard error of the proportion**.

We can estimate the standard error of p_hat using the squared root function **sqrt()**. We can do it step by step, or all at once as below.
```{r,eval=FALSE}
# standard error
SE <- sqrt((p_hat*(1-p_hat))/n)
SE
```

According to this, a mean proportion of sentinel birds of 0.30±0.03 (mean±SE) produce an alarm call in the presence of raptors. 

<br>

**D. Testing hypotheses: the binomial test and the χ2 goodness-of-fit**.

We estimated the binomial probabilities given *X*, *n*, and *p*. This is different from testing a hypothesis, which requires a null probability of success $p_0$ and a *p*-value. 

<br>

<span style='color:#66023C; font-size:100%; font-weight:600'> **Stop, Think:** </span> In this case, we have information about the proportion of sentinel birds producing an alarm call during a control trial. During a control trial, a researcher would stand at the same distance as in a raptor trial from the bird flock and carry out the same gesture as if he/she was releasing a trained raptor. However, there was no raptor involved in the trial. **Stop** and review the definition of a null hypothesis. **Think** about why the researcher would simulate the same gesture in a control trial. 

<br> 

If fact, we can use the information from the control trials to build our null hypothesis. If we estimate the proportion of sentinel birds producing an alarm call during a control trial, we can use such proportion as our expected proportion of birds producing alarm calls ($p_0$) when a researcher is standing close to the flock, independently of the presence of a raptor.

```{r,eval=FALSE}
# proportion of birds producing alarm calls in a control trial
p_null <- sum(control$Alarm_Call)/length(control$RAPTOR)
p_null
```

<br>

Considering our research question, our null and alternate hypotheses are:

$H_0$: In the presence of raptors, 3.125% of sentinel birds produce an alarm call.

$H_A$: In the presence of raptors, the proportion of sentinel birds producing an alarm call is not 3.125%.

<br>

In R, we can use the function **binom.test()** to carry out a binomial test. Similar to **dbinom()**, the three arguments in the function are *X*, *n*, and *p_null*. 
```{r,eval=FALSE}
# binomial test
binom.test(X, n, p_null)
```
According to this, the probability of success is not equal to 3.125% and thus, we reject the null hypothesis (*p*-value < 0.0001). 

<br>



**Questions**

  a. *Does the presence of a predator increases the proportion of alarm calls produced by sentinel birds?*
  b. *Can we make an argument that raptors are a major driver shaping the landscape of fear of Amazonian birds?* 

<br>

**2. Research question**: Is raptor size a visual cue driving the proportion of sentinel birds producing alarm calls?

<br>

<span style='color:#66023C; font-size:100%; font-weight:600'> **Stop, Think, Do:** </span> Now, it is your turn to test this hypothesis about raptor size. **Stop** and review the steps (A-D) you just did. **Think** about how to manage the "raptor" data set to obtain the data needed to address the research question. **Do** the analysis following the demonstration codes  and answer the research question! **Super Hint**: Create a new data frame filtering "raptor" by SIZE=="small" and follow the steps above using the same null hypothesis.

<br>

<center>
**Great Work!**
</center>
<br>

*** 


<span style='color:#66023C; font-size:150%; font-weight:600'> Take-home exercise </span> 
<br> 

**Task.** In order to address the second research question, we need to also estimate binomial probabilities for the large raptor trials. Following your exercise on small raptor trials, filter your data by large raptor size and properly address question #2. **Keep in mind that you should use the same null hypothesis as above, no need to estimate *p*_null again**. Create an annotated R script that includes the following steps; (1) data import, (2) package loading, (3) codes for each step (A-D) using both the small and large raptor size datasets. Accompany your R script with a concluding paragraph summarizing your results. Use the Info-Box as a guide to report results in your paragraph. Your assignment should include two files; (1) a .doc file with the figures and paragraph, (2) an .R file containing your annotated R script.

